<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BlockCraft 3D - Gra PrzeglƒÖdarkowa</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            font-family: 'VT323', monospace;
            overflow: hidden;
            background: #1a1a2e;
            color: #fff;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* UI Overlay */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
        }
        
        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }
        
        #crosshair::before {
            width: 2px;
            height: 10px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        #crosshair::after {
            width: 10px;
            height: 2px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Hotbar */
        #hotbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 10px;
            pointer-events: auto;
        }
        
        .slot {
            width: 50px;
            height: 50px;
            background: rgba(100, 100, 100, 0.5);
            border: 3px solid #555;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .slot.active {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
        }
        
        .slot .block-icon {
            width: 40px;
            height: 40px;
            border-radius: 3px;
        }
        
        .slot .count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 14px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        
        /* Controls Info */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            line-height: 1.5;
            max-width: 300px;
        }
        
        #controls h3 {
            color: #00f5ff;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        #controls kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #555;
        }
        
        /* Mobile Controls */
        #mobileControls {
            display: none;
            position: absolute;
            bottom: 100px;
            left: 20px;
            pointer-events: auto;
        }
        
        .d-pad {
            position: relative;
            width: 150px;
            height: 150px;
        }
        
        .d-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fff;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .d-btn:active {
            background: rgba(0, 245, 255, 0.4);
            border-color: #00f5ff;
        }
        
        .d-btn.up { top: 0; left: 50px; }
        .d-btn.down { bottom: 0; left: 50px; }
        .d-btn.left { top: 50px; left: 0; }
        .d-btn.right { top: 50px; right: 0; }
        
        #actionButtons {
            position: absolute;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        
        .action-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 0, 255, 0.3);
            border: 3px solid #ff00ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #fff;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .action-btn:active {
            background: rgba(255, 0, 255, 0.6);
            transform: scale(0.95);
        }
        
        .action-btn.break {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
        }
        
        /* Start Screen */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            pointer-events: auto;
        }
        
        #startScreen h1 {
            font-size: 72px;
            color: #00f5ff;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.8);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        #startScreen p {
            font-size: 24px;
            color: #ccc;
            margin-bottom: 40px;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 28px;
            font-family: 'VT323', monospace;
            background: linear-gradient(135deg, #00f5ff, #0080ff);
            border: none;
            border-radius: 10px;
            color: #000;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.6);
        }
        
        .author-info {
            margin-top: 40px;
            text-align: center;
            font-size: 18px;
            color: #888;
        }
        
        .author-info a {
            color: #ff00ff;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .author-info a:hover {
            color: #00ff88;
        }
        
        /* Audio Controls */
        #audioControls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        
        .audio-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff88;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .audio-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: scale(1.1);
        }
        
        .audio-btn.muted {
            border-color: #ff0000;
            opacity: 0.5;
        }
        
        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #00f5ff;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 245, 255, 0.3);
            border-top-color: #00f5ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            #mobileControls, #actionButtons {
                display: block;
            }
            
            #controls {
                display: none;
            }
            
            #startScreen h1 {
                font-size: 48px;
            }
            
            .slot {
                width: 40px;
                height: 40px;
            }
            
            .slot .block-icon {
                width: 30px;
                height: 30px;
            }
        }
        
        /* Block textures */
        .grass { background: linear-gradient(to bottom, #00ff88 0%, #00ff88 30%, #8B4513 30%, #8B4513 100%); }
        .dirt { background: #8B4513; }
        .stone { background: #808080; }
        .wood { background: #654321; }
        .leaves { background: #228B22; }
        .sand { background: #F4A460; }
        .water { background: linear-gradient(135deg, #0080ff, #00f5ff); }
        .lava { background: linear-gradient(135deg, #ff4500, #ff0000); }
        .diamond { background: linear-gradient(135deg, #00ffff, #0080ff); }
        .gold { background: linear-gradient(135deg, #ffd700, #ff8c00); }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="canvas"></canvas>
        
        <div id="ui">
            <div id="crosshair"></div>
            
            <div id="controls">
                <h3>üéÆ Sterowanie</h3>
                <p><kbd>WASD</kbd> - Ruch</p>
                <p><kbd>MYSZ</kbd> - Obr√≥t kamery</p>
                <p><kbd>LPM</kbd> - Niszczenie blok√≥w</p>
                <p><kbd>PPM</kbd> - Stawianie blok√≥w</p>
                <p><kbd>1-9</kbd> - Wyb√≥r bloku</p>
                <p><kbd>SPACJA</kbd> - Skok</p>
                <p><kbd>ESC</kbd> - Pauza</p>
            </div>
            
            <div id="audioControls">
                <div class="audio-btn" id="musicBtn" title="Muzyka">üéµ</div>
                <div class="audio-btn" id="soundBtn" title="D≈∫wiƒôki">üîä</div>
            </div>
            
            <div id="mobileControls">
                <div class="d-pad">
                    <div class="d-btn up" data-dir="up">‚ñ≤</div>
                    <div class="d-btn down" data-dir="down">‚ñº</div>
                    <div class="d-btn left" data-dir="left">‚óÄ</div>
                    <div class="d-btn right" data-dir="right">‚ñ∂</div>
                </div>
            </div>
            
            <div id="actionButtons">
                <div class="action-btn break" id="breakBtn">‚õèÔ∏è</div>
                <div class="action-btn" id="placeBtn">üß±</div>
                <div class="action-btn" id="jumpBtn">‚¨ÜÔ∏è</div>
            </div>
            
            <div id="hotbar">
                <div class="slot active" data-type="grass">
                    <div class="block-icon grass"></div>
                    <span class="count">‚àû</span>
                </div>
                <div class="slot" data-type="dirt">
                    <div class="block-icon dirt"></div>
                    <span class="count">‚àû</span>
                </div>
                <div class="slot" data-type="stone">
                    <div class="block-icon stone"></div>
                    <span class="count">‚àû</span>
                </div>
                <div class="slot" data-type="wood">
                    <div class="block-icon wood"></div>
                    <span class="count">‚àû</span>
                </div>
                <div class="slot" data-type="sand">
                    <div class="block-icon sand"></div>
                    <span class="count">‚àû</span>
                </div>
                <div class="slot" data-type="diamond">
                    <div class="block-icon diamond"></div>
                    <span class="count">‚àû</span>
                </div>
                <div class="slot" data-type="gold">
                    <div class="block-icon gold"></div>
                    <span class="count">‚àû</span>
                </div>
            </div>
        </div>
        
        <div id="startScreen">
            <h1>‚õèÔ∏è BLOCKCRAFT 3D ‚õèÔ∏è</h1>
            <p>Buduj, eksploruj i tw√≥rz w≈Çasny ≈õwiat!</p>
            <button class="btn" id="startBtn">üéÆ GRAJ TERAZ</button>
            <div class="author-info">
                <p>Stworzone przez <strong>Damian Kita</strong></p>
                <p>üîó <a href="https://linktr.ee/kitadamian" target="_blank">linktr.ee/kitadamian</a></p>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner"></div>
            <div>Generowanie ≈õwiata...</div>
        </div>
    </div>

    <script>
        // Audio System
        const AudioSys = {
            ctx: null,
            musicEnabled: true,
            soundEnabled: true,
            musicOscillators: [],
            
            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            
            // Procedural music generation
            playMusic() {
                if (!this.musicEnabled || !this.ctx) return;
                
                const notes = [130.81, 146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63];
                const melody = [0, 2, 4, 2, 0, 4, 7, 4];
                let noteIndex = 0;
                
                const playNote = () => {
                    if (!this.musicEnabled) return;
                    
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    
                    osc.type = 'sine';
                    osc.frequency.value = notes[melody[noteIndex % melody.length]];
                    
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                    
                    osc.start(this.ctx.currentTime);
                    osc.stop(this.ctx.currentTime + 0.5);
                    
                    noteIndex++;
                    setTimeout(playNote, 500);
                };
                
                playNote();
                
                // Ambient background drone
                const drone = this.ctx.createOscillator();
                const droneGain = this.ctx.createGain();
                drone.connect(droneGain);
                droneGain.connect(this.ctx.destination);
                drone.type = 'triangle';
                drone.frequency.value = 65.41;
                droneGain.gain.value = 0.05;
                drone.start();
                this.musicOscillators.push(drone);
            },
            
            stopMusic() {
                this.musicOscillators.forEach(osc => osc.stop());
                this.musicOscillators = [];
            },
            
            // Sound effects
            playBreakSound() {
                if (!this.soundEnabled || !this.ctx) return;
                this.playNoise(0.1, 200, 'square');
            },
            
            playPlaceSound() {
                if (!this.soundEnabled || !this.ctx) return;
                this.playTone(400, 0.1, 'sine');
            },
            
            playJumpSound() {
                if (!this.soundEnabled || !this.ctx) return;
                this.playTone(300, 0.15, 'triangle');
            },
            
            playStepSound() {
                if (!this.soundEnabled || !this.ctx) return;
                this.playNoise(0.05, 100, 'sawtooth', 0.3);
            },
            
            playTone(freq, duration, type = 'sine') {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            
            playNoise(duration, freq, type, vol = 0.2) {
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = freq;
                
                const gain = this.ctx.createGain();
                gain.gain.value = vol;
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },
            
            toggleMusic() {
                this.musicEnabled = !this.musicEnabled;
                if (this.musicEnabled) this.playMusic();
                else this.stopMusic();
                return this.musicEnabled;
            },
            
            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                return this.soundEnabled;
            }
        };

        // Game Engine
        const Game = {
            canvas: document.getElementById('canvas'),
            ctx: null,
            world: new Map(),
            player: {
                x: 0,
                y: 10,
                z: 0,
                rotX: 0,
                rotY: 0,
                vx: 0,
                vy: 0,
                vz: 0,
                onGround: false,
                height: 1.8,
                width: 0.6
            },
            selectedBlock: 'grass',
            blockSize: 1,
            renderDistance: 8,
            keys: {},
            mouse: { x: 0, y: 0, locked: false },
            mobile: { up: false, down: false, left: false, right: false },
            
            blockTypes: {
                grass: { color: '#00ff88', sideColor: '#8B4513' },
                dirt: { color: '#8B4513' },
                stone: { color: '#808080' },
                wood: { color: '#654321' },
                leaves: { color: '#228B22' },
                sand: { color: '#F4A460' },
                water: { color: '#0080ff', transparent: true },
                lava: { color: '#ff4500', transparent: true },
                diamond: { color: '#00ffff' },
                gold: { color: '#ffd700' }
            },
            
            init() {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                this.generateWorld();
                this.setupControls();
                this.setupMobileControls();
                
                // Lock pointer on click
                this.canvas.addEventListener('click', () => {
                    if (!this.mouse.locked && !this.isMobile()) {
                        this.canvas.requestPointerLock();
                    }
                });
                
                document.addEventListener('pointerlockchange', () => {
                    this.mouse.locked = document.pointerLockElement === this.canvas;
                });
                
                this.loop();
            },
            
            isMobile() {
                return window.innerWidth <= 768 || 'ontouchstart' in window;
            },
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.centerX = this.canvas.width / 2;
                this.centerY = this.canvas.height / 2;
            },
            
            generateWorld() {
                // Generate terrain using simple noise
                const size = 32;
                for (let x = -size; x <= size; x++) {
                    for (let z = -size; z <= size; z++) {
                        const height = Math.floor(Math.sin(x * 0.1) * Math.cos(z * 0.1) * 5) + 5;
                        
                        for (let y = -5; y <= height; y++) {
                            let type = 'stone';
                            if (y === height) type = 'grass';
                            else if (y >= height - 2) type = 'dirt';
                            
                            this.setBlock(x, y, z, type);
                        }
                        
                        // Trees
                        if (Math.random() < 0.02 && height > 0) {
                            this.generateTree(x, height + 1, z);
                        }
                        
                        // Ores
                        if (Math.random() < 0.01) {
                            this.setBlock(x, height - 3, z, Math.random() > 0.5 ? 'diamond' : 'gold');
                        }
                    }
                }
            },
            
            generateTree(x, y, z) {
                // Trunk
                for (let i = 0; i < 4; i++) {
                    this.setBlock(x, y + i, z, 'wood');
                }
                // Leaves
                for (let lx = -2; lx <= 2; lx++) {
                    for (let lz = -2; lz <= 2; lz++) {
                        for (let ly = 3; ly <= 5; ly++) {
                            if (Math.abs(lx) + Math.abs(lz) + Math.abs(ly - 4) < 4) {
                                this.setBlock(x + lx, y + ly, z + lz, 'leaves');
                            }
                        }
                    }
                }
            },
            
            setBlock(x, y, z, type) {
                const key = `${Math.floor(x)},${Math.floor(y)},${Math.floor(z)}`;
                if (type === null) {
                    this.world.delete(key);
                } else {
                    this.world.set(key, { x: Math.floor(x), y: Math.floor(y), z: Math.floor(z), type });
                }
            },
            
            getBlock(x, y, z) {
                const key = `${Math.floor(x)},${Math.floor(y)},${Math.floor(z)}`;
                return this.world.get(key) || null;
            },
            
            setupControls() {
                // Keyboard
                window.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    
                    // Hotbar
                    if (e.key >= '1' && e.key <= '9') {
                        const index = parseInt(e.key) - 1;
                        const slots = document.querySelectorAll('.slot');
                        if (slots[index]) {
                            slots.forEach(s => s.classList.remove('active'));
                            slots[index].classList.add('active');
                            this.selectedBlock = slots[index].dataset.type;
                        }
                    }
                    
                    if (e.code === 'Space' && this.player.onGround) {
                        this.player.vy = 0.3;
                        this.player.onGround = false;
                        AudioSys.playJumpSound();
                    }
                    
                    if (e.code === 'Escape') {
                        document.exitPointerLock();
                    }
                });
                
                window.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // Mouse
                window.addEventListener('mousemove', (e) => {
                    if (this.mouse.locked) {
                        this.player.rotY -= e.movementX * 0.002;
                        this.player.rotX -= e.movementY * 0.002;
                        this.player.rotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.player.rotX));
                    }
                });
                
                // Mouse buttons
                this.canvas.addEventListener('mousedown', (e) => {
                    if (!this.mouse.locked) return;
                    
                    if (e.button === 0) this.breakBlock();
                    if (e.button === 2) this.placeBlock();
                });
                
                this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // Hotbar clicks
                document.querySelectorAll('.slot').forEach(slot => {
                    slot.addEventListener('click', () => {
                        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
                        slot.classList.add('active');
                        this.selectedBlock = slot.dataset.type;
                    });
                });
            },
            
            setupMobileControls() {
                // D-pad
                document.querySelectorAll('.d-btn').forEach(btn => {
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.mobile[btn.dataset.dir] = true;
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.mobile[btn.dataset.dir] = false;
                    });
                });
                
                // Action buttons
                document.getElementById('breakBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.breakBlock();
                });
                
                document.getElementById('placeBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.placeBlock();
                });
                
                document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.player.onGround) {
                        this.player.vy = 0.3;
                        this.player.onGround = false;
                        AudioSys.playJumpSound();
                    }
                });
                
                // Touch look
                let lastTouchX = 0, lastTouchY = 0;
                this.canvas.addEventListener('touchstart', (e) => {
                    lastTouchX = e.touches[0].clientX;
                    lastTouchY = e.touches[0].clientY;
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 1) {
                        const dx = e.touches[0].clientX - lastTouchX;
                        const dy = e.touches[0].clientY - lastTouchY;
                        this.player.rotY -= dx * 0.01;
                        this.player.rotX -= dy * 0.01;
                        this.player.rotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.player.rotX));
                        lastTouchX = e.touches[0].clientX;
                        lastTouchY = e.touches[0].clientY;
                    }
                });
            },
            
            getTargetBlock() {
                const reach = 5;
                const step = 0.1;
                
                let x = this.player.x;
                let y = this.player.y + this.player.height / 2;
                let z = this.player.z;
                
                const dx = Math.sin(this.player.rotY) * Math.cos(this.player.rotX);
                const dy = Math.sin(this.player.rotX);
                const dz = -Math.cos(this.player.rotY) * Math.cos(this.player.rotX);
                
                for (let d = 0; d < reach; d += step) {
                    x += dx * step;
                    y += dy * step;
                    z += dz * step;
                    
                    const block = this.getBlock(x, y, z);
                    if (block) {
                        return {
                            block: block,
                            face: this.getFace(x, y, z, dx, dy, dz),
                            x: Math.floor(x),
                            y: Math.floor(y),
                            z: Math.floor(z)
                        };
                    }
                }
                return null;
            },
            
            getFace(x, y, z, dx, dy, dz) {
                const fx = x - Math.floor(x);
                const fy = y - Math.floor(y);
                const fz = z - Math.floor(z);
                
                if (fx < 0.01) return { x: -1, y: 0, z: 0 };
                if (fx > 0.99) return { x: 1, y: 0, z: 0 };
                if (fy < 0.01) return { x: 0, y: -1, z: 0 };
                if (fy > 0.99) return { x: 0, y: 1, z: 0 };
                if (fz < 0.01) return { x: 0, y: 0, z: -1 };
                return { x: 0, y: 0, z: 1 };
            },
            
            breakBlock() {
                const target = this.getTargetBlock();
                if (target) {
                    this.setBlock(target.x, target.y, target.z, null);
                    AudioSys.playBreakSound();
                    
                    // Particle effect
                    this.createParticles(target.x, target.y, target.z, this.blockTypes[target.block.type].color);
                }
            },
            
            placeBlock() {
                const target = this.getTargetBlock();
                if (target) {
                    const nx = target.x + target.face.x;
                    const ny = target.y + target.face.y;
                    const nz = target.z + target.face.z;
                    
                    // Don't place inside player
                    if (Math.abs(nx - this.player.x) < 0.8 && 
                        Math.abs(ny - this.player.y) < 1.8 && 
                        Math.abs(nz - this.player.z) < 0.8) {
                        return;
                    }
                    
                    this.setBlock(nx, ny, nz, this.selectedBlock);
                    AudioSys.playPlaceSound();
                }
            },
            
            createParticles(x, y, z, color) {
                // Simple particle effect
                for (let i = 0; i < 8; i++) {
                    // Particles would be rendered in 3D, simplified here
                }
            },
            
            update() {
                // Movement
                const speed = 0.15;
                let moveX = 0;
                let moveZ = 0;
                
                if (this.keys['KeyW'] || this.mobile.up) {
                    moveX += Math.sin(this.player.rotY) * speed;
                    moveZ -= Math.cos(this.player.rotY) * speed;
                }
                if (this.keys['KeyS'] || this.mobile.down) {
                    moveX -= Math.sin(this.player.rotY) * speed;
                    moveZ += Math.cos(this.player.rotY) * speed;
                }
                if (this.keys['KeyA'] || this.mobile.left) {
                    moveX -= Math.cos(this.player.rotY) * speed;
                    moveZ -= Math.sin(this.player.rotY) * speed;
                }
                if (this.keys['KeyD'] || this.mobile.right) {
                    moveX += Math.cos(this.player.rotY) * speed;
                    moveZ += Math.sin(this.player.rotY) * speed;
                }
                
                // Apply movement with collision
                this.moveWithCollision(moveX, 0, moveZ);
                
                // Gravity
                this.player.vy -= 0.02;
                this.moveWithCollision(0, this.player.vy, 0);
                
                // Ground check
                if (this.player.y < -20) {
                    this.player.y = 20;
                    this.player.vy = 0;
                }
                
                // Step sound
                if (this.player.onGround && (Math.abs(moveX) > 0.01 || Math.abs(moveZ) > 0.01)) {
                    if (Math.random() < 0.05) AudioSys.playStepSound();
                }
            },
            
            moveWithCollision(dx, dy, dz) {
                const newX = this.player.x + dx;
                const newY = this.player.y + dy;
                const newZ = this.player.z + dz;
                
                // Check collision with player bounding box
                const checkCollision = (x, y, z) => {
                    for (let bx = Math.floor(x - 0.3); bx <= Math.floor(x + 0.3); bx++) {
                        for (let by = Math.floor(y); by <= Math.floor(y + 1.8); by++) {
                            for (let bz = Math.floor(z - 0.3); bz <= Math.floor(z + 0.3); bz++) {
                                if (this.getBlock(bx, by, bz)) return true;
                            }
                        }
                    }
                    return false;
                };
                
                // X collision
                if (!checkCollision(newX, this.player.y, this.player.z)) {
                    this.player.x = newX;
                } else {
                    this.player.vx = 0;
                }
                
                // Y collision
                if (!checkCollision(this.player.x, newY, this.player.z)) {
                    this.player.y = newY;
                    this.player.onGround = false;
                } else {
                    if (dy < 0) this.player.onGround = true;
                    this.player.vy = 0;
                }
                
                // Z collision
                if (!checkCollision(this.player.x, this.player.y, newZ)) {
                    this.player.z = newZ;
                } else {
                    this.player.vz = 0;
                }
            },
            
            render() {
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                // Clear
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, w, h);
                
                // Sky gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, h);
                gradient.addColorStop(0, '#0a0a0f');
                gradient.addColorStop(0.5, '#1a1a2e');
                gradient.addColorStop(1, '#16213e');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, w, h);
                
                // Simple 3D projection
                const fov = 800;
                const blocks = [];
                
                // Collect visible blocks
                for (const [key, block] of this.world) {
                    const dx = block.x - this.player.x;
                    const dy = block.y - this.player.y - 1;
                    const dz = block.z - this.player.z;
                    const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                    
                    if (dist > this.renderDistance) continue;
                    
                    // Rotate
                    const cosY = Math.cos(-this.player.rotY);
                    const sinY = Math.sin(-this.player.rotY);
                    const cosX = Math.cos(-this.player.rotX);
                    const sinX = Math.sin(-this.player.rotX);
                    
                    let rx = dx * cosY - dz * sinY;
                    let rz = dx * sinY + dz * cosY;
                    let ry = dy * cosX - rz * sinX;
                    rz = dy * sinX + rz * cosX;
                    
                    if (rz > 0.1) {
                        const scale = fov / rz;
                        const sx = this.centerX + rx * scale;
                        const sy = this.centerY + ry * scale;
                        const size = scale;
                        
                        blocks.push({
                            block, sx, sy, size, dist, rz,
                            x: block.x, y: block.y, z: block.z
                        });
                    }
                }
                
                // Sort by distance (painter's algorithm)
                blocks.sort((a, b) => b.dist - a.dist);
                
                // Draw blocks
                for (const b of blocks) {
                    if (b.size < 5) continue;
                    
                    const type = this.blockTypes[b.block.type];
                    const brightness = Math.max(0.3, 1 - b.dist / this.renderDistance);
                    
                    // Draw cube faces
                    ctx.save();
                    ctx.translate(b.sx, b.sy);
                    
                    // Top face
                    ctx.fillStyle = this.adjustBrightness(type.color, brightness * 1.2);
                    ctx.beginPath();
                    ctx.moveTo(-b.size/2, -b.size/2);
                    ctx.lineTo(0, -b.size/1.5);
                    ctx.lineTo(b.size/2, -b.size/2);
                    ctx.lineTo(0, -b.size/3);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Front face
                    ctx.fillStyle = this.adjustBrightness(type.color, brightness);
                    ctx.fillRect(-b.size/2, -b.size/2, b.size, b.size);
                    
                    // Side face
                    ctx.fillStyle = this.adjustBrightness(type.color, brightness * 0.8);
                    ctx.beginPath();
                    ctx.moveTo(b.size/2, -b.size/2);
                    ctx.lineTo(b.size/1.3, -b.size/1.5);
                    ctx.lineTo(b.size/1.3, b.size/3);
                    ctx.lineTo(b.size/2, b.size/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Highlight target
                    const target = this.getTargetBlock();
                    if (target && target.block === b.block) {
                        ctx.strokeStyle = '#00f5ff';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(-b.size/2, -b.size/2, b.size, b.size);
                    }
                    
                    ctx.restore();
                }
                
                // Draw target highlight
                if (blocks.length === 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '20px VT323';
                    ctx.textAlign = 'center';
                    ctx.fillText('Brak blok√≥w w zasiƒôgu wzroku', w/2, h/2 + 50);
                }
            },
            
            adjustBrightness(color, factor) {
                const hex = color.replace('#', '');
                const r = Math.min(255, Math.floor(parseInt(hex.substr(0, 2), 16) * factor));
                const g = Math.min(255, Math.floor(parseInt(hex.substr(2, 2), 16) * factor));
                const b = Math.min(255, Math.floor(parseInt(hex.substr(4, 2), 16) * factor));
                return `rgb(${r},${g},${b})`;
            },
            
            loop() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.loop());
            }
        };

        // Initialize
        document.getElementById('startBtn').addEventListener('click', async () => {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            // Initialize audio
            AudioSys.init();
            AudioSys.playMusic();
            
            // Small delay for effect
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                Game.init();
            }, 1000);
        });
        
        // Audio controls
        document.getElementById('musicBtn').addEventListener('click', function() {
            const enabled = AudioSys.toggleMusic();
            this.classList.toggle('muted', !enabled);
            this.textContent = enabled ? 'üéµ' : 'üîá';
        });
        
        document.getElementById('soundBtn').addEventListener('click', function() {
            const enabled = AudioSys.toggleSound();
            this.classList.toggle('muted', !enabled);
            this.textContent = enabled ? 'üîä' : 'üîá';
        });
        
        // Prevent context menu on canvas
        document.getElementById('canvas').addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>